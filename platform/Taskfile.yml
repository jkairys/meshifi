version: "3"

tasks:
  install-functions:
    desc: "Install Crossplane Functions required by Meshifi"
    silent: true
    cmds:
      - |
        echo "ğŸ“¦ Installing Crossplane Functions..."
        kubectl apply -f core/functions.yaml

        echo "â³ Waiting for Functions to be installed..."
        kubectl wait --for=condition=Installed --timeout=300s function.pkg.crossplane.io/crossplane-contrib-function-go-templating
        kubectl wait --for=condition=Installed --timeout=300s function.pkg.crossplane.io/crossplane-contrib-function-auto-ready
        kubectl wait --for=condition=Installed --timeout=300s function.pkg.crossplane.io/crossplane-contrib-function-extra-resources

        echo "â³ Waiting for Functions to be healthy..."
        kubectl wait --for=condition=Healthy --timeout=300s function.pkg.crossplane.io/crossplane-contrib-function-go-templating
        kubectl wait --for=condition=Healthy --timeout=300s function.pkg.crossplane.io/crossplane-contrib-function-auto-ready
        kubectl wait --for=condition=Healthy --timeout=300s function.pkg.crossplane.io/crossplane-contrib-function-extra-resources

        echo "âœ… Crossplane Functions installed and ready!"

  install:
    desc: "Install the Meshifi platform"
    silent: true
    deps: [install-functions]
    cmds:
      - task: install-package
        vars:
          PACKAGE: core

  uninstall:
    desc: "Uninstall the Meshifi platform"
    silent: true
    cmds:
      - task: uninstall-package
        vars:
          PACKAGE: core

  # Meshifi Package Installation
  install-package:
    desc: "Install the specified Meshifi package"
    silent: true
    requires:
      vars: [PACKAGE]
    cmds:
      - |
        PACKAGE="{{.PACKAGE}}"

        # Note: We'll install the package components directly instead of using a package definition
        echo "â„¹ï¸  Installing Meshifi ${PACKAGE} package components directly..."

        # Apply the CRDs (idempotent)
        echo "ğŸ“‹ Applying CompositeResourceDefinitions..."
        kubectl apply -f {{.PACKAGE}}/xrds/

        # Apply the compositions (idempotent)
        echo "ğŸ“‹ Applying Compositions..."
        kubectl apply -f {{.PACKAGE}}/compositions/

  uninstall-package:
    silent: true
    requires:
      vars: [PACKAGE]
    desc: "Uninstall the Meshifi ${PACKAGE} package"
    cmds:
      - |
        echo "ğŸ—‘ï¸  Uninstalling Meshifi ${PACKAGE} package..."

        # Delete compositions
        echo "ğŸ—‘ï¸  Removing compositions..."
        kubectl delete -f {{.PACKAGE}}/compositions/ --ignore-not-found=true

        # Delete CRDs
        echo "ğŸ—‘ï¸  Removing CompositeResourceDefinitions..."
        kubectl delete -f {{.PACKAGE}}/xrds/ --ignore-not-found=true

        echo "âœ… Meshifi {{.PACKAGE}} package uninstalled"

  install-samples:
    desc: "Install the Meshifi samples"
    silent: true
    cmds:
      - |
        # Apply example data domain
        echo "ğŸ“‹ Creating example DataDomain..."
        kubectl apply -f examples/data-domain.yaml

        # Apply example data product
        echo "ğŸ“‹ Creating example DataProduct..."
        kubectl apply -f examples/data-product.yaml

  uninstall-samples:
    desc: "Uninstall the Meshifi samples"
    silent: true
    cmds:
      - |
        echo "ğŸ—‘ï¸  Uninstalling Meshifi samples..."
        kubectl delete -f examples/ --ignore-not-found=true
        echo "âœ… Meshifi samples uninstalled"

  # Testing
  test:
    desc: "Test the Meshifi package with example resources"
    silent: true
    deps: [install]
    cmds:
      - echo "ğŸ§ª Testing Meshifi package with example resources..."
      - task: install-samples
      - |
        # Check if GCP credentials are available
        if kubectl get secret gcp-provider-creds -n default &> /dev/null; then
          echo "ğŸ” GCP credentials found - waiting for resources to be fully provisioned..."
          echo "â³ Waiting for resources to be ready..."
          kubectl wait --for=condition=Ready --timeout=120s datadomain/example-domain
          kubectl wait --for=condition=Ready --timeout=120s dataproduct/sales-data
          echo "âœ… Resources are ready and provisioned in GCP!"
        else
          echo "â„¹ï¸  No GCP credentials found - validating composition logic only..."
          echo "â³ Waiting for DataDomain to be ready (doesn't require GCP)..."
          kubectl wait --for=condition=Ready --timeout=120s datadomain/example-domain

          echo "â³ Waiting for DataProduct to be synced..."
          # Wait for the composite to be synced (but not necessarily ready)
          kubectl wait --for=condition=Synced --timeout=60s dataproduct/sales-data || true

          echo "âœ… Compositions validated - resources created but not provisioned in GCP"
          echo "â„¹ï¸  To fully provision resources, set GCP_SA_KEY environment variable"
        fi

        # Show status
        echo ""
        echo "ğŸ“‹ DataDomain status:"
        kubectl get datadomain example-domain -o yaml
        echo ""
        echo "ğŸ“‹ DataProduct status:"
        kubectl get dataproduct sales-data -o yaml
        echo ""
        echo "ğŸ“‹ Created ConfigMaps:"
        kubectl get configmaps -l meshifi.io/type
        echo ""
        echo "ğŸ“‹ Managed Resources:"
        kubectl get managed || true
    summary: "Test the package by creating example resources"

  cleanup-test:
    desc: "Clean up test resources"
    silent: true
    cmds:
      - |
        echo "ğŸ§¹ Cleaning up test resources..."
        kubectl delete -f examples/ --ignore-not-found=true
        echo "âœ… Test resources cleaned up"

  # Help
  help:
    desc: "Show available Meshifi package tasks"
    cmds:
      - task --list
