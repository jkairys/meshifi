version: "3"

vars:
  GCP_PROJECT_ID: '{{.GCP_PROJECT_ID | default "meshifi-platform"}}'

includes:
  dev:
    taskfile: dev-environment/Taskfile.yaml
    dir: dev-environment
  platform:
    taskfile: platform/Taskfile.yml
    dir: platform

tasks:
  verify:
    desc: "Run complete verification workflow (creates env, installs platform, runs tests)"
    summary: |
      Complete verification workflow that:
      - Creates a Kind cluster
      - Installs Crossplane
      - Sets up GCP provider (if GCP_SA_KEY is set)
      - Installs the Meshifi platform
      - Installs and tests sample resources
      - Shows cluster status
      - Cleans up test resources

      This replicates the GitHub workflow locally.

      Environment variables:
        GCP_PROJECT_ID: GCP project ID (default: meshifi-platform)
        GCP_SA_KEY: GCP service account key JSON (optional)
    cmds:
      - echo "ğŸš€ Starting Meshifi verification workflow..."
      - task: setup-dev
      - task: test-platform
      - defer: { task: cleanup-test }
      - defer: { task: show-status }
      - echo "âœ… Verification workflow completed successfully!"

  setup-dev:
    desc: "Set up development environment (cluster + Crossplane)"
    summary: |
      Sets up the complete development environment:
      - Creates Kind cluster
      - Installs Crossplane
      - Sets up GCP provider (if GCP_SA_KEY environment variable is set)
    cmds:
      - echo "ğŸ“¦ Setting up development environment..."
      - task: dev:kind:create
      - task: dev:crossplane:install
      - task: setup-gcp-if-available
      - echo "âœ… Development environment ready!"

  setup-gcp-if-available:
    desc: "Set up GCP provider if credentials are available"
    silent: true
    cmds:
      - |
        if [ -n "$GCP_SA_KEY" ]; then
          echo "ğŸ” GCP credentials found, setting up GCP provider..."
          cd dev-environment && task crossplane-gcp:setup
        else
          echo "â„¹ï¸  No GCP credentials found (GCP_SA_KEY not set), skipping GCP provider setup"
          echo "â„¹ï¸  Resources will be created but not provisioned in GCP"
        fi

  test-platform:
    desc: "Install and test the Meshifi platform with samples"
    summary: |
      Installs the Meshifi platform and runs smoke tests:
      - Installs Crossplane functions
      - Installs platform XRDs and compositions
      - Creates example DataDomain and DataProduct
      - Waits for resources to be ready
      - Validates resource status
    cmds:
      - echo "ğŸ§ª Installing and testing Meshifi platform..."
      - cd platform && task install
      - cd platform && task test
      - echo "âœ… Platform tests passed!"

  cleanup-test:
    desc: "Clean up test resources"
    cmds:
      - echo "ğŸ§¹ Cleaning up test resources..."
      - cd platform && task cleanup-test || true
      - echo "âœ… Test resources cleaned up"

  show-status:
    desc: "Show cluster and platform status"
    summary: |
      Displays comprehensive status information:
      - Cluster nodes
      - Crossplane system pods
      - Meshifi resources (DataDomains, DataProducts)
      - Resource details and events
      - ConfigMaps
    cmds:
      - |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ“Š Cluster and Platform Status"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        echo "ğŸ” Cluster Nodes:"
        kubectl get nodes
        echo ""

        echo "ğŸ” Crossplane System Pods:"
        kubectl get pods -n crossplane-system || true
        echo ""

        echo "ğŸ” Meshifi Resources:"
        kubectl get datadomains,dataproducts || true
        echo ""

        echo "ğŸ” DataDomain Details:"
        kubectl describe datadomain example-domain 2>/dev/null || echo "No example-domain found"
        echo ""

        echo "ğŸ” DataProduct Details:"
        kubectl describe dataproduct sales-data 2>/dev/null || echo "No sales-data found"
        echo ""

        echo "ğŸ” ConfigMaps (Meshifi):"
        kubectl get configmaps -l meshifi.io/type 2>/dev/null || echo "No Meshifi ConfigMaps found"
        echo ""

        echo "ğŸ” All ConfigMaps:"
        kubectl get configmaps
        echo ""

        echo "ğŸ” Recent Events:"
        kubectl get events --sort-by='.lastTimestamp' | tail -20
        echo ""

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  debug:
    desc: "Show detailed debug information for troubleshooting"
    summary: |
      Displays detailed debugging information when tests fail:
      - DataDomain and DataProduct YAML manifests
      - Events for specific resources
      - Crossplane compositions and XRDs
      - All managed and composite resources
    cmds:
      - |
        echo ""
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo "ğŸ› Debug Information"
        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""

        echo "ğŸ“‹ DataDomain Status:"
        kubectl get datadomain example-domain -o yaml 2>/dev/null || echo "No example-domain found"
        echo ""

        echo "ğŸ“‹ DataDomain Events:"
        kubectl get events --field-selector involvedObject.name=example-domain --sort-by='.lastTimestamp' 2>/dev/null || true
        echo ""

        echo "ğŸ“‹ DataProduct Status:"
        kubectl get dataproduct sales-data -o yaml 2>/dev/null || echo "No sales-data found"
        echo ""

        echo "ğŸ“‹ DataProduct Events:"
        kubectl get events --field-selector involvedObject.name=sales-data --sort-by='.lastTimestamp' 2>/dev/null || true
        echo ""

        echo "ğŸ“‹ Crossplane Compositions:"
        kubectl get compositions || true
        echo ""

        echo "ğŸ“‹ Crossplane XRDs:"
        kubectl get xrds || true
        echo ""

        echo "ğŸ“‹ All Crossplane Resources:"
        kubectl get managed,composite,composition -A || true
        echo ""

        echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  cleanup:
    desc: "Clean up development environment (removes cluster)"
    summary: |
      Complete cleanup of the development environment:
      - Removes test resources
      - Deletes the Kind cluster

      Note: This will destroy all local development resources.
    cmds:
      - echo "ğŸ§¹ Cleaning up development environment..."
      - task: cleanup-test
      - task: dev:kind:delete
      - echo "âœ… Development environment cleaned up!"

  # Convenience tasks
  install:
    desc: "Install the Meshifi platform"
    cmds:
      - cd platform && task install

  install-samples:
    desc: "Install sample DataDomain and DataProduct"
    cmds:
      - cd platform && task install-samples

  uninstall:
    desc: "Uninstall the Meshifi platform"
    cmds:
      - cd platform && task uninstall

  help:
    desc: "Show available tasks"
    cmds:
      - task --list
